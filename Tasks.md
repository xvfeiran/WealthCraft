# 投资组合（UI与逻辑）

创建/编辑投资组合，包含：
**基础信息**
- 组合名称
- 基础币种
**资产结构**
- 子组合，可包含0~n个资产
- 资产
- 在子组合中或者直接在投资组合中添加资产时，可以通过代码、名称模糊匹配资产
**投资规则**
- 定投：可以设定定投周期，每个子组合/资产设定每次定投的金额
- 固定比例：可以设定每项资产/子组合（不包括子组合下的资产）的比例，要求总和为100%

投资建议
在投资组合概览页，如果该组合为固定比例，那么就可以根据当前的子组合和直接资产（非子组合内的资产）比例与设定比例的差值，推荐再平衡。
可以切换再平衡方式：仅买再平衡/买卖再平衡

# 业务背景知识

投资组合由**资产结构**与**投资规则**组成。

## 1. 资产结构

* 投资组合可包含多个资产类别（Asset Class）
* 每个资产类别下可添加多个资产（Asset）

## 2. 投资规则（Portfolio Rules）

投资组合可配置以下规则（可单独或组合使用）：

### 2.1 Allocation Rule（资产配置规则）

* 为各资产类别设定目标持仓比例

### 2.2 Contribution Rule（资金投入规则）

* 按设定周期投入固定金额（定投）

### 2.3 Rebalancing Rule（再平衡规则）

* 当持仓比例偏离目标配置时执行再平衡

---

## 投资建议（Investment Recommendation）

在投资组合概览页，根据以下数据生成投资建议：

* 当前持仓（Current Holdings）
* Allocation Rule
* Contribution Rule

系统提供两种再平衡模式：

---

### 再平衡模式

#### 1. 卖出再平衡（Sell-based Rebalancing）

不使用新资金，仅通过买卖现有资产使组合回到目标比例。

**逻辑：**

1. 计算当前组合总市值。
2. 根据目标比例计算各资产目标市值。
3. 对比当前市值与目标市值：

   ```
   delta = target_value - current_value
   ```
4. 若 delta > 0 → 建议买入该资产
   若 delta < 0 → 建议卖出该资产
5. 输出每个资产的建议买入或卖出金额。

---

#### 2. 买入再平衡（Contribution-based Rebalancing）

仅使用本次投入资金，不卖出现有资产。

**逻辑：**

1. 获取本次投入金额（Contribution）。
2. 计算当前组合总市值。
3. 计算投入后组合总市值：

   ```
   new_total = current_total + contribution
   ```
4. 根据目标比例计算各资产目标市值。
5. 计算资金缺口：

   ```
   gap = max(0, target_value - current_value)
   ```
6. 按各资产缺口比例分配本次投入资金。
7. 输出每个资产的建议买入金额。

---

### 特殊情况

#### 1. 只有 Contribution Rule

* 每次按预设投资比例分配投入金额。

#### 2. 只有 Allocation Rule

* 仅提供卖出再平衡建议。
* 不计算买入金额。

## 组合操作
- 创建组合后可以添加资产，此时可以写入持仓成本/数量/手续费，也可以不写入
- 可以在已有资产上有新的操作，如：买入/卖出，填入对应的价格/时间/手续费