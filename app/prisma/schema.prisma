generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String         @id @default(uuid())
  email                 String         @unique
  passwordHash          String
  baseCurrency          String         @default("CNY")
  notificationThreshold Float          @default(0.05)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  portfolios            Portfolio[]
  notifications         Notification[]
  channels              Channel[]
}

model Portfolio {
  id                  String           @id @default(uuid())
  userId              String
  name                String
  baseCurrency        String           @default("CNY")
  // 投资规则类型: CONTRIBUTION(定投) | ALLOCATION(固定比例) - 二选一
  ruleType            String?          // CONTRIBUTION, ALLOCATION
  // 定投规则设置 (仅当 ruleType = CONTRIBUTION 时使用)
  contributionPeriod  String?          // DAILY, WEEKLY, MONTHLY
  // 固定比例规则: 各子组合/直接资产的比例存在各自记录中
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  subPortfolios       SubPortfolio[]
  assets              Asset[]          // 直接持有的资产（非子组合内）
  recommendations     Recommendation[]

  @@index([userId])
}

// 子组合 - 不可嵌套，只能属于一个投资组合
model SubPortfolio {
  id                  String    @id @default(uuid())
  portfolioId         String
  name                String
  // 定投规则: 每次定投金额 (仅当 portfolio.ruleType = CONTRIBUTION 时使用)
  contributionAmount  Float     @default(0)
  // 固定比例规则: 目标比例 (仅当 portfolio.ruleType = ALLOCATION 时使用)
  allocationPercent   Float     @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  portfolio           Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  assets              Asset[]

  @@index([portfolioId])
}

model Asset {
  id                  String           @id @default(uuid())
  portfolioId         String
  subPortfolioId      String?          // 所属子组合ID，null表示直接在组合下
  symbol              String
  name                String
  market              String           // 交易所: SSE, SSE_FUND, SSE_BOND, NASDAQ, NYSE, AMEX, US_ETF
  currency            String           @default("CNY")
  quantity            Float            @default(0)
  costPrice           Float            @default(0)
  currentPrice        Float            @default(0)
  startDate           DateTime         @default(now()) // 资产开始持有时间
  // 定投规则: 每次定投金额 (仅当直接在组合下且 portfolio.ruleType = CONTRIBUTION 时使用)
  contributionAmount  Float            @default(0)
  // 固定比例规则: 目标比例 (仅当直接在组合下且 portfolio.ruleType = ALLOCATION 时使用)
  allocationPercent   Float            @default(0)
  source              String           @default("MANUAL") // SYNC, MANUAL
  channelId           String?          // 关联的交易渠道ID（可选）
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  portfolio           Portfolio        @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  subPortfolio        SubPortfolio?    @relation(fields: [subPortfolioId], references: [id], onDelete: SetNull)
  channel             Channel?         @relation(fields: [channelId], references: [id], onDelete: SetNull)
  transactions        Transaction[]
  syncLogs            SyncLog[]
  recommendations     Recommendation[]

  @@unique([portfolioId, symbol])
  @@index([portfolioId])
  @@index([subPortfolioId])
}

model Transaction {
  id        String   @id @default(uuid())
  assetId   String
  channelId String?  // 交易渠道
  type      String   // BUY, SELL, DIVIDEND, FEE
  quantity  Float
  price     Float
  fee       Float    @default(0)
  timestamp DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  channel   Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)

  @@index([assetId])
  @@index([channelId])
}

// 交易渠道配置
model Channel {
  id           String        @id @default(uuid())
  userId       String
  name         String        // 渠道名称，如：南方基金、老虎证券、IBKR
  currency     String        @default("CNY") // 账户币种
  account      String?       // 账号（可选）
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  assets       Asset[]

  @@index([userId])
}

model Recommendation {
  id                String    @id @default(uuid())
  portfolioId       String
  assetId           String
  action            String    // BUY, SELL
  suggestedQuantity Float
  reason            String
  createdAt         DateTime  @default(now())
  portfolio         Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset             Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
}

model Notification {
  id             String   @id @default(uuid())
  userId         String
  type           String   // RATIO_DEVIATION, PRICE_ALERT
  triggeredValue Float
  message        String
  readStatus     Boolean  @default(false)
  timestamp      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SyncLog {
  id        String   @id @default(uuid())
  assetId   String
  oldPrice  Float
  newPrice  Float
  source    String
  timestamp DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

// 汇率表 - 存储每日汇率中间价
model ExchangeRate {
  id          String    @id @default(uuid())
  fromCurrency String   // 源货币代码，如 USD, EUR
  toCurrency   String   // 目标货币代码，如 CNY
  rate         Float    // 汇率
  date         DateTime @default(now()) // 汇率日期
  source       String   @default("CHINAMONEY") // 数据源
  createdAt    DateTime  @default(now())

  @@unique([fromCurrency, toCurrency, date])
  @@index([date])
  @@index([fromCurrency, toCurrency])
}

// 投资标的主数据 - 从第三方API同步
model MarketInstrument {
  id           String   @id @default(uuid())
  symbol       String   // 股票/基金代码
  name         String   // 名称
  market       String   // 交易所: SSE(上交所), SZSE(深交所), NASDAQ, NYSE, AMEX, US_ETF, NF_FUND, BOSERA, EFUNDS
  type         String   // 类型: STOCK, FUND, ETF, BOND
  currency     String   @default("CNY")

  // 价格相关
  lastPrice    Float    @default(0)
  change       Float    @default(0)       // 涨跌额
  changePercent Float   @default(0)       // 涨跌幅
  volume       Float    @default(0)       // 成交量
  marketCap    Float    @default(0)       // 市值

  // 基金特有字段（可选，仅基金使用）
  fundType         String?  // 基金类型: 股票型, 债券型, 混合型, 货币型, 指数型, QDII, FOF, REITs, 互认基金
  riskLevel        String?  // 风险等级: 低风险(R1), 中低风险(R2), 中风险(R3), 中高风险(R4), 高风险(R5)
  managerName      String?  // 基金经理
  setupDate        DateTime? // 成立日期
  navDate          DateTime? // 净值日期

  // 收益率数据（基金）
  yield7d          Float?   // 七日年化收益率（货币基金）
  yield1w          Float?   // 近一周收益率
  yield1m          Float?   // 近一月收益率
  yield3m          Float?   // 近三月收益率
  yield6m          Float?   // 近六月收益率
  yield1y          Float?   // 近一年收益率
  yieldYtd         Float?   // 今年以来收益率
  yieldSinceInception Float? // 成立以来收益率

  // 股票特有字段（可选，仅股票使用）
  sector       String?  // 行业
  industry     String?  // 细分行业
  country      String?  // 国家

  // 通用字段
  isActive     Boolean  @default(true) // 是否交易中
  lastSyncAt   DateTime @default(now()) // 最后同步时间
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([symbol, market])
  @@index([market])
  @@index([type])
  @@index([name])
  @@index([symbol])
}

// 同步任务日志
model SyncTask {
  id          String   @id @default(uuid())
  market      String   // 交易所
  status      String   // PENDING, RUNNING, SUCCESS, FAILED
  totalCount  Int      @default(0)
  successCount Int     @default(0)
  failedCount Int      @default(0)
  errorMessage String?
  startedAt   DateTime @default(now())
  completedAt DateTime?
}
