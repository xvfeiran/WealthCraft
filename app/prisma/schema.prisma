generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String         @id @default(uuid())
  email                 String         @unique
  passwordHash          String
  baseCurrency          String         @default("CNY")
  notificationThreshold Float          @default(0.05)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  portfolios            Portfolio[]
  notifications         Notification[]
}

model Portfolio {
  id                  String           @id @default(uuid())
  userId              String
  name                String
  baseCurrency        String           @default("CNY")
  // 投资规则类型: CONTRIBUTION(定投) | ALLOCATION(固定比例) - 二选一
  ruleType            String?          // CONTRIBUTION, ALLOCATION
  // 定投规则设置 (仅当 ruleType = CONTRIBUTION 时使用)
  contributionPeriod  String?          // DAILY, WEEKLY, MONTHLY
  // 固定比例规则: 各子组合/直接资产的比例存在各自记录中
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  subPortfolios       SubPortfolio[]
  assets              Asset[]          // 直接持有的资产（非子组合内）
  recommendations     Recommendation[]

  @@index([userId])
}

// 子组合 - 不可嵌套，只能属于一个投资组合
model SubPortfolio {
  id                  String    @id @default(uuid())
  portfolioId         String
  name                String
  // 定投规则: 每次定投金额 (仅当 portfolio.ruleType = CONTRIBUTION 时使用)
  contributionAmount  Float     @default(0)
  // 固定比例规则: 目标比例 (仅当 portfolio.ruleType = ALLOCATION 时使用)
  allocationPercent   Float     @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  portfolio           Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  assets              Asset[]

  @@index([portfolioId])
}

model Asset {
  id                  String           @id @default(uuid())
  portfolioId         String
  subPortfolioId      String?          // 所属子组合ID，null表示直接在组合下
  symbol              String
  name                String
  market              String           // 交易所: SSE, SSE_FUND, SSE_BOND, NASDAQ, NYSE, AMEX, US_ETF
  currency            String           @default("CNY")
  quantity            Float            @default(0)
  costPrice           Float            @default(0)
  currentPrice        Float            @default(0)
  // 定投规则: 每次定投金额 (仅当直接在组合下且 portfolio.ruleType = CONTRIBUTION 时使用)
  contributionAmount  Float            @default(0)
  // 固定比例规则: 目标比例 (仅当直接在组合下且 portfolio.ruleType = ALLOCATION 时使用)
  allocationPercent   Float            @default(0)
  source              String           @default("MANUAL") // SYNC, MANUAL
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  portfolio           Portfolio        @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  subPortfolio        SubPortfolio?    @relation(fields: [subPortfolioId], references: [id], onDelete: SetNull)
  transactions        Transaction[]
  syncLogs            SyncLog[]
  recommendations     Recommendation[]

  @@unique([portfolioId, symbol])
  @@index([portfolioId])
  @@index([subPortfolioId])
}

model Transaction {
  id        String   @id @default(uuid())
  assetId   String
  type      String   // BUY, SELL, DIVIDEND, FEE
  quantity  Float
  price     Float
  fee       Float    @default(0)
  timestamp DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

model Recommendation {
  id                String    @id @default(uuid())
  portfolioId       String
  assetId           String
  action            String    // BUY, SELL
  suggestedQuantity Float
  reason            String
  createdAt         DateTime  @default(now())
  portfolio         Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  asset             Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
}

model Notification {
  id             String   @id @default(uuid())
  userId         String
  type           String   // RATIO_DEVIATION, PRICE_ALERT
  triggeredValue Float
  message        String
  readStatus     Boolean  @default(false)
  timestamp      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SyncLog {
  id        String   @id @default(uuid())
  assetId   String
  oldPrice  Float
  newPrice  Float
  source    String
  timestamp DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

model ExchangeRate {
  id           String   @id @default(uuid())
  fromCurrency String
  toCurrency   String
  rate         Float
  updatedAt    DateTime @updatedAt

  @@unique([fromCurrency, toCurrency])
}

// 投资标的主数据 - 从第三方API同步
model MarketInstrument {
  id           String   @id @default(uuid())
  symbol       String   // 股票/基金代码
  name         String   // 名称
  market       String   // 交易所: SSE(上交所), SZSE(深交所), NASDAQ, NYSE
  type         String   // 类型: STOCK, FUND, ETF, BOND
  currency     String   @default("CNY")
  lastPrice    Float    @default(0)
  change       Float    @default(0)    // 涨跌额
  changePercent Float   @default(0)    // 涨跌幅
  volume       Float    @default(0)    // 成交量
  marketCap    Float    @default(0)    // 市值
  sector       String?  // 行业
  industry     String?  // 细分行业
  country      String?  // 国家
  isActive     Boolean  @default(true) // 是否交易中
  lastSyncAt   DateTime @default(now()) // 最后同步时间
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([symbol, market])
  @@index([market])
  @@index([name])
  @@index([symbol])
}

// 同步任务日志
model SyncTask {
  id          String   @id @default(uuid())
  market      String   // 交易所
  status      String   // PENDING, RUNNING, SUCCESS, FAILED
  totalCount  Int      @default(0)
  successCount Int     @default(0)
  failedCount Int      @default(0)
  errorMessage String?
  startedAt   DateTime @default(now())
  completedAt DateTime?
}
